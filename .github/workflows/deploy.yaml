name: Deploy to dev environment on push to main

on:
  push:
    branches: [ main ]
    paths:
      - 'force-app/**'

jobs:
  Deploy-to-dev-environment:
      runs-on: ubuntu-latest
      environment: dev
      steps:
          - uses: actions/setup-node@v3
            with:
              node-version: '18'
          - name: 'Checkout source code'
            uses: actions/checkout@v3
            with:
              fetch-depth: '2'
                
          # Now Install Salesforce CLI
          - name: 'Install sfdx'
            run: npm install @salesforce/cli --global
          - name: 'Installing sfdx git delta'
            run: | 
                sf plugins install sfdx-git-delta
                sf plugins

          - name: 'Create delta packages'
            run: | 
                mkdir changed-sources
                sf sgd source delta --to "HEAD" --from "HEAD~1" --output changed-sources/ --generate-delta --source force-app/ || true
                echo "[INFO] Diff generated"
                # Verify delta packages exist
                if [ -d "changed-sources/force-app" ]; then
                  echo "[INFO] Delta packages created successfully"
                else
                  echo "[WARNING] No delta changes detected or delta output structure differs"
                fi

          - name: 'validate deployment before deploying, deploy only if validation is successful'
            run: |
                   echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
                   sf org login jwt --username ${{ secrets.DEPLOYMENT_USER_NAME }} --jwt-key-file server.key --client-id ${{ secrets.CONSUMER_KEY }} --instance-url ${{ vars.INSTANCE_URL }} --set-default
                   
                   # Check if there are delta changes to deploy
                   if [ ! -d "changed-sources/force-app" ]; then
                     echo "[WARNING] No delta changes detected in the commit. Skipping main source deployment."
                     echo "DEPLOY_ID=" > deploy_id.txt
                     exit 0
                   fi
                   
                   echo "[INFO] Delta changes detected. Proceeding with validation and deployment."
                   sf project deploy validate --source-dir changed-sources/force-app --test-level RunLocalTests
                   
                   DEPLOY_ID=$(sf project deploy list --status InProgress --json | jq -r '.result[0].id')
                   echo "VALIDATION ID: $DEPLOY_ID"
                   if [ $? -eq 0 ]
                   then 
                      echo "Validation successful. Proceeding to deployment."
                      sf project deploy start --source-dir changed-sources/force-app --test-level RunLocalTests
                      DEPLOY_ID=$(sf project deploy list --status InProgress --json | jq -r '.result[0].id')
                      echo "Deployment ID: $DEPLOY_ID"
                      echo "$DEPLOY_ID" > deploy_id.txt
                   else 
                      echo "Validation failed. Deployment aborted."
                      exit 1
                   fi
          - name: 'Generate delta for dependent metadata (Objects, Custom Fields, Validation Rules)'
            run: |
                  # Create output directory for dependent metadata
                  mkdir -p delta-dependencies
                  
                  # Verify sgd plugin is available
                  sf plugins --core | grep -i delta || echo "[WARNING] sfdx-git-delta may not be installed"
                  
                  # Generate delta for metadata that profiles depend on
                  sf sgd source delta --to "HEAD" --from "HEAD~1" --output delta-dependencies/ --source force-app/ --metadata "CustomObject,CustomField,ValidationRule,RecordType" || true
                  echo "[INFO] Dependent Metadata Diff generated"
                  
                  # List detected changes for visibility
                  if [ -d "delta-dependencies/force-app/main/default/objects" ]; then
                    echo "[INFO] Object/Field changes detected"
                    find delta-dependencies/force-app/main/default/objects -type f -name "*.xml" | head -20
                  fi

          - name: 'Deploy dependent metadata first (Objects, Fields, Validation Rules)'
            run: |
                  # Check if there are dependent metadata changes
                  if [ -d "delta-dependencies/force-app/main/default/objects" ] || [ -d "delta-dependencies/force-app/main/default/validationrules" ] || [ -d "delta-dependencies/force-app/main/default/recordtypes" ]; then
                    echo "[STEP 1] Deploying dependent metadata (Objects, Custom Fields, Validation Rules)..."
                    
                    # Validate dependent metadata
                    echo "Validating dependent metadata..."
                    sf project deploy validate --source-dir delta-dependencies/ --test-level NoTestRun
                    
                    if [ $? -eq 0 ]; then
                      echo "Validation successful. Proceeding to deploy dependent metadata."
                      sf project deploy start --source-dir delta-dependencies/ --test-level NoTestRun
                      DEP_DEPLOY_ID=$(sf project deploy list --status InProgress --json | jq -r '.result[0].id')
                      echo "Dependent Metadata Deployment ID: $DEP_DEPLOY_ID"
                      
                      # Wait for deployment to complete
                      echo "Waiting for dependent metadata deployment to complete..."
                      sf project deploy report "$DEP_DEPLOY_ID" --wait 60
                      if [ $? -eq 0 ]; then
                        echo "Dependent metadata deployment completed successfully."
                        sf project deploy report "$DEP_DEPLOY_ID" --json | jq -r '.result | "Status: \(.status), Done: \(.done)"'
                      else
                        echo "Dependent metadata deployment failed or timed out."
                        exit 1
                      fi
                    else
                      echo "Validation failed. Dependent metadata validation failed."
                      exit 1
                    fi
                  else
                    echo "[STEP 1] No dependent metadata changes detected. Proceeding to profile deployment."
                  fi

          - name: 'Generate delta for Profile and PermissionSet metadata'
            run: |
                  # Create output directory for profile metadata
                  mkdir -p delta-profiles
                  
                  # Generate delta for Profile and PermissionSet only
                  sf sgd source delta --to "HEAD" --from "HEAD~1" --output delta-profiles/ --source force-app/ --metadata "Profile,PermissionSet" || true
                  echo "[INFO] Profile/PermissionSet Metadata Diff generated"
                  
                  # List detected changes for visibility
                  if [ -d "delta-profiles/force-app/main/default/profiles" ]; then
                    echo "[INFO] Profile changes detected:"
                    find delta-profiles/force-app/main/default/profiles -type f -name "*.profile-meta.xml" | xargs -I {} basename {}
                  fi
                  if [ -d "delta-profiles/force-app/main/default/permissionsets" ]; then
                    echo "[INFO] PermissionSet changes detected:"
                    find delta-profiles/force-app/main/default/permissionsets -type f -name "*.permissionset-meta.xml" | xargs -I {} basename {}
                  fi

          - name: 'Deploy Profile and PermissionSet with FLS and Object Access'
            run: |
                  # Check if there are profile or permission set changes
                  if [ -d "delta-profiles/force-app/main/default/profiles" ] || [ -d "delta-profiles/force-app/main/default/permissionsets" ]; then
                    echo "[STEP 2] Deploying Profile/PermissionSet metadata with FLS and object access changes..."
                    
                    # Validate profile/permission set changes
                    echo "Validating profile and permission set changes..."
                    sf project deploy validate --source-dir delta-profiles/ --test-level NoTestRun
                    
                    if [ $? -eq 0 ]; then
                      echo "Validation successful. Profile FLS and object access changes are valid."
                      
                      # Deploy profiles and permission sets
                      echo "Proceeding to profile and permission set deployment..."
                      sf project deploy start --source-dir delta-profiles/ --test-level NoTestRun
                      PROFILE_DEPLOY_ID=$(sf project deploy list --status InProgress --json | jq -r '.result[0].id')
                      echo "Profile Deployment ID: $PROFILE_DEPLOY_ID"
                      
                      # Wait for deployment to complete
                      echo "Waiting for profile deployment to complete..."
                      sf project deploy report "$PROFILE_DEPLOY_ID" --wait 60
                      if [ $? -eq 0 ]; then
                        echo "Profile deployment completed successfully."
                        
                        # Report deployment details
                        echo "[SUCCESS] Profile/PermissionSet FLS and object access deployment successful."
                        sf project deploy report "$PROFILE_DEPLOY_ID" --json | jq -r '.result | "Deployment Status: \(.status), Completed: \(.done), Total Deployed: \(.numberDeployed)"'
                      else
                        echo "Profile deployment failed or timed out."
                        exit 1
                      fi
                    else
                      echo "Validation failed. Profile FLS and object access validation failed. Aborting deployment."
                      exit 1
                    fi
                  else
                    echo "[STEP 2] No Profile or PermissionSet changes detected. Skipping profile deployment."
                  fi
          - name: 'if running test classes display test class names and their status'
            run: |
                  sf project deploy report $DEPLOY_ID --verbose --json | jq -r '.result.testResults[] | "Test Class: \(.name), Status: \(.outcome)"'
                #DEPLOY_ID=$(sf project deploy list --status InProgress --json | jq -r '.result[0].id')
                   #echo "Deployment ID: $DEPLOY_ID"
                   

                

           #############################     
          #- name: 'Deploy to environment with running all local tests'
           # run: |
            #    echo "${{ secrets.JWT_SERVER_KEY }}" > server.key
             #   sf org login jwt --username ${{ secrets.DEPLOYMENT_USER_NAME }} --jwt-key-file server.key --client-id ${{ secrets.CONSUMER_KEY }} --instance-url ${{ vars.INSTANCE_URL }} --set-default
              #  sf project deploy start --source-dir changed-sources/force-app --test-level RunLocalTests

          #- name: 'Deploy the changes and run test classes if any apex class in the branch'
           # run: |
            #      if [ -d "changed-sources/force-app/main/default/classes" ] 
             #     then 
              #      echo "Apex classes found in the changes. Running all local tests."
               #     sf project deploy start --source-dir changed-sources/force-app --test-level RunLocalTests
                #  else 
                 #   echo "No Apex classes found in the changes. Deploying without running tests."
                  #  sf project deploy start --source-dir changed-sources/force-app --test-level NoTestRun
                  #fi
          #- name: 'validate deployment before deploying, deploy only if validation is successful'
           # run: |
            #      sf project deploy validate --source-dir changed-sources/force-app --test-level RunLocalTests